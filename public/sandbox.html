<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sandbox Iframe</title>
  </head>
  <body>
    <script>
      window.addEventListener('message', (event) => {
        const originalConsoleLog = console.log; // For debugging
        originalConsoleLog('Message received in sandbox:', event.data);

        const parentWindow = event.source;
        const parentOrigin = event.origin;
        const codeToRun = event.data;

        let messages = [];
        let timerMap = {};

        // Store original methods
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalDir = console.dir;
        const originalTable = console.table;
        const originalTime = console.time;
        const originalTimeEnd = console.timeEnd;

        // Override console.log (optional: remove originalLog if not needed)
        console.log = (...args) => {
          const text = args.join(' ');
          messages.push({ type: 'log', text });
          // originalLog(...args); // Comment out to avoid browser console
        };

        // Override console.error
        console.error = (...args) => {
          const text = args.join(' ');
          messages.push({ type: 'error', text });
          // originalError(...args);
        };

        // Override console.warn
        console.warn = (...args) => {
          const text = args.join(' ');
          messages.push({ type: 'warn', text });
          // originalWarn(...args);
        };

        // Override console.dir
        console.dir = (obj) => {
          let serialized;
          try {
            serialized = JSON.stringify(obj, null, 2);
          } catch (error) {
            serialized = 'Unserializable object';
          }
          messages.push({ type: 'dir', data: serialized });
          // originalDir(obj);
        };

        // Override console.table
        console.table = (tabularData) => {
          let tablePayload;
          try {
            tablePayload = JSON.parse(JSON.stringify(tabularData));
          } catch (error) {
            tablePayload = String(tabularData);
          }
          messages.push({ type: 'table', data: tablePayload });
          // originalTable(tabularData);
        };

        // Override console.time
        console.time = (label = "default") => {
          originalConsoleLog('Starting timer for label:', label); // Debug
          timerMap[label] = performance.now();
          // Do NOT call originalTime(label) to avoid browser console
        };

        // Override console.timeEnd
        console.timeEnd = (label = "default") => {
          originalConsoleLog('Ending timer for label:', label); // Debug
          if (timerMap[label] !== undefined) {
            const duration = performance.now() - timerMap[label];
            const timeMessage = {
              type: 'time',
              label,
              duration: duration.toFixed(2)
            };
            messages.push(timeMessage);
            originalConsoleLog('Pushed time message:', timeMessage); // Debug
            delete timerMap[label];
          } else {
            messages.push({
              type: 'warn',
              text: `No such label '${label}' for console.timeEnd()`
            });
          }
          // Do NOT call originalTimeEnd(label) to avoid browser console
        };

        try {
          const runnable = new Function(codeToRun);
          const result = runnable();
          if (result !== undefined) {
            messages.push({ type: 'log', text: String(result) });
          }
        } catch (err) {
          messages.push({ type: 'error', text: `Error: ${err.message}` });
        }

        // Restore original methods
        console.log = originalLog;
        console.error = originalError;
        console.warn = originalWarn;
        console.dir = originalDir;
        console.table = originalTable;
        console.time = originalTime;
        console.timeEnd = originalTimeEnd;

        // Debug log before sending
        originalConsoleLog('Sending messages:', messages);
        parentWindow.postMessage(messages, parentOrigin);
      });
    </script>
  </body>
</html>