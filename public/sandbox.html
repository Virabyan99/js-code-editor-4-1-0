<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sandbox Iframe</title>
  </head>
  <body>
    <script>
      // Listen for messages from the parent containing code to execute
      window.addEventListener('message', (event) => {
        // Save the original console.log for debugging
        const originalConsoleLog = console.log;
        originalConsoleLog('Message received in sandbox:', event.data); // Debug log

        const parentWindow = event.source;
        const parentOrigin = event.origin;
        const codeToRun = event.data;

        // Array to store console messages
        let messages = [];

        // Keep references to original console methods
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalDir = console.dir;
        const originalTable = console.table;

        // Override console.log
        console.log = (...args) => {
          const text = args.join(' ');
          messages.push({ type: 'log', text });
          originalLog(...args);
        };

        // Override console.error
        console.error = (...args) => {
          const text = args.join(' ');
          messages.push({ type: 'error', text });
          originalError(...args);
        };

        // Override console.warn
        console.warn = (...args) => {
          const text = args.join(' ');
          messages.push({ type: 'warn', text });
          originalWarn(...args);
        };

        // Override console.dir
        console.dir = (obj) => {
          let serialized;
          try {
            serialized = JSON.stringify(obj, null, 2); // Serialize object to JSON
          } catch (error) {
            serialized = 'Unserializable object';
          }
          messages.push({ type: 'dir', data: serialized });
          originalDir(obj);
        };

        // Override console.table
        console.table = (tabularData) => {
          let tablePayload;
          try {
            tablePayload = JSON.parse(JSON.stringify(tabularData)); // Shallow copy for safety
          } catch (error) {
            tablePayload = String(tabularData);
          }
          messages.push({ type: 'table', data: tablePayload });
          originalTable(tabularData);
        };

        try {
          // Execute the user-provided code
          const runnable = new Function(codeToRun);
          const result = runnable();
          if (result !== undefined) {
            messages.push({ type: 'log', text: String(result) });
          }
        } catch (err) {
          messages.push({ type: 'error', text: `Error: ${err.message}` });
        }

        // Restore original console methods
        console.log = originalLog;
        console.error = originalError;
        console.warn = originalWarn;
        console.dir = originalDir;
        console.table = originalTable;

        // Send captured messages to the parent window
        parentWindow.postMessage(messages, parentOrigin);
      });
    </script>
  </body>
</html>